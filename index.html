<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>影视管理与全自动化中枢系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
    <div id="app">
        <el-container style="height: 100vh;">
            <el-header>🎬 本地影视订阅与自动化控制台</el-header>
            
            <el-container>
                <el-aside width="240px">
                    <el-menu
                        active-text-color="#409EFF"
                        background-color="#304156"
                        text-color="#bfcbd9"
                        :default-active="activeMenu"
                        :default-openeds="['media_group', 'settings_group']"
                        @select="handleMenuSelect"
                    >
                        <el-sub-menu index="media_group">
                            <template #title><span>🔥 热门推荐</span></template>
                            <el-menu-item index="hot">🔥 今日热门</el-menu-item>
                            <el-menu-item index="movie">🎬 电影库</el-menu-item>
                            <el-menu-item index="tv">📺 剧集库</el-menu-item>
                            <el-menu-item index="discover">🔍 全网搜索</el-menu-item>
                        </el-sub-menu>

                        <el-menu-item index="subscriptions">📚 我的订阅清单</el-menu-item>
                        
                        <el-sub-menu index="settings_group">
                            <template #title><span>⚙️ 系统设置</span></template>
                            <el-menu-item index="settings">⚙️ 接口配置</el-menu-item>
                            <el-menu-item index="settings_cron">⏰ 任务定时与CMS</el-menu-item>
                            <el-menu-item index="settings_115">☁️ 115网盘扫码登录</el-menu-item>
                            <el-menu-item index="system_logs">📋 系统运行日志</el-menu-item>
                        </el-sub-menu>
                    </el-menu>
                </el-aside>

                <el-main class="main-content" v-loading.fullscreen.lock="syncingData" element-loading-text="首次打开，正在为您拉取今日热门数据...">
                    
                    <div v-if="['hot', 'movie', 'tv', 'discover'].includes(activeMenu)">
                        <div class="top-bar"><h2>{{ getMenuTitle(activeMenu) }}</h2></div>
                        <div v-if="activeMenu === 'discover'" style="display: flex; gap: 10px; max-width: 600px; margin-bottom: 20px;">
                            <el-input v-model="searchQuery" placeholder="输入你想找的电影或剧集..." @keyup.enter="searchTMDB"></el-input>
                            <el-button type="primary" @click="searchTMDB" :loading="loading">搜索</el-button>
                        </div>
                        <div class="media-grid" v-loading="loading">
                            <el-card v-for="item in (activeMenu === 'discover' ? searchResults : localMedia)" :key="item.id || item.tmdb_id" :body-style="{ padding: '10px' }" shadow="hover">
                                <img :src="item.poster_path ? config.image_domain + '/t/p/w500' + item.poster_path : 'https://via.placeholder.com/200x300?text=No+Image'" class="poster">
                                <div class="media-info">
                                    <h3 class="title">{{ item.title || item.name }}</h3>
                                    <p class="overview">{{ item.overview || '暂无简介' }}</p>
                                    <div class="action-group">
                                        <el-button type="primary" size="small" style="flex: 1;" :plain="item.is_subscribed" :disabled="item.is_subscribed" @click="subscribe(item, activeMenu !== 'discover')">
                                            {{ item.is_subscribed ? '已订阅' : '订阅' }}
                                        </el-button>
                                        <el-button type="success" size="small" style="flex: 1;" @click="openPanSou(item.title || item.name)">🔍 搜网盘</el-button>
                                    </div>
                                </div>
                            </el-card>
                            <el-empty v-if="activeMenu !== 'discover' && localMedia.length === 0 && !loading" description="本地数据库暂无数据"></el-empty>
                        </div>
                    </div>

                    <div v-if="activeMenu === 'subscriptions'">
                        <h2>📚 我的订阅清单</h2>
                        <el-table :data="subscriptions" style="width: 100%" v-loading="loading">
                            <el-table-column label="海报" width="100">
                                <template #default="scope"><img :src="config.image_domain + '/t/p/w200' + scope.row.poster_path" style="width: 50px; border-radius: 4px;"></template>
                            </el-table-column>
                            <el-table-column prop="title" label="名称" width="220"></el-table-column>
                            <el-table-column label="类型" width="80">
                                <template #default="scope"><el-tag size="small">{{ scope.row.media_type === 'movie' ? '电影' : '剧集' }}</el-tag></template>
                            </el-table-column>
                            <el-table-column prop="status" label="状态" width="100">
                                <template #default="scope">
                                    <el-tag :type="scope.row.status === 'pending' ? 'warning' : 'success'">{{ scope.row.status === 'pending' ? '⏳ 采集中' : '✅ 已完成' }}</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="overview" label="剧情简介"></el-table-column>
                            <el-table-column label="操作" width="200" align="center">
                                <template #default="scope">
                                    <el-button type="success" size="small" @click="openPanSou(scope.row.title)">搜网盘</el-button>
                                    <el-button type="danger" size="small" plain @click="unsubscribeMedia(scope.row)">取消订阅</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <div v-if="activeMenu === 'settings'">
                        <h2>⚙️ 接口配置</h2>
                        <div class="settings-wrapper">
                            <el-card shadow="never">
                                <el-form label-width="130px" style="margin-top: 20px;">
                                    <el-divider content-position="left">TMDB 配置</el-divider>
                                    <el-form-item label="API 域名"><el-input v-model="config.api_domain"></el-input></el-form-item>
                                    <el-form-item label="图片域名"><el-input v-model="config.image_domain"></el-input></el-form-item>
                                    <el-form-item label="API Key"><el-input v-model="config.api_key" type="password" show-password></el-input></el-form-item>
                                    
                                    <el-divider content-position="left">盘搜对接配置</el-divider>
                                    <el-form-item label="盘搜 API 地址"><el-input v-model="config.pansou_domain"></el-input></el-form-item>
                                    
                                    <el-form-item style="margin-top: 30px;"><el-button type="primary" @click="saveConfig">保存配置</el-button></el-form-item>
                                </el-form>
                            </el-card>
                        </div>
                    </div>

                    <div v-if="activeMenu === 'settings_cron'">
                        <h2>⏰ 任务定时与 CMS 推送设置</h2>
                        <div class="settings-wrapper">
                            <el-card shadow="never">
                                <el-alert title="自动化流程说明" type="success" description="系统将根据 Cron 规则定时扫描您的订阅清单，调用盘搜自动按照 115 > 磁力 > 阿里云盘 的优先级抓取最高清资源，并自动推送到 CloudMediaSynC 下载。推送成功后自动清理订阅。" show-icon style="margin-bottom: 20px;"></el-alert>
                                
                                <el-form label-width="150px">
                                    <el-divider content-position="left">执行频率控制 (Cron表达式)</el-divider>
                                    <el-form-item label="Cron 定时规则">
                                        <el-input v-model="config.cron_expression" placeholder="例如: 0 2 * * * (每天凌晨两点)"></el-input>
                                        <div style="font-size: 12px; color: #999;">格式: 分 时 日 月 周 (注意：修改后需重启后端才能生效)</div>
                                    </el-form-item>
                                    
                                    <el-divider content-position="left">CloudMediaSynC (CMS) 对接</el-divider>
                                    <el-form-item label="CMS API 地址">
                                        <el-input v-model="config.cms_api_url" placeholder="例如: http://127.0.0.1:8090"></el-input>
                                    </el-form-item>
                                    <el-form-item label="CMS Token认证">
                                        <el-input v-model="config.cms_api_token" type="password" show-password placeholder="如有则填，没有留空"></el-input>
                                    </el-form-item>

                                    <el-form-item style="margin-top: 30px;">
                                        <el-button type="primary" @click="saveConfig">保存配置</el-button>
                                        <el-button type="warning" @click="triggerTaskManual">手动运行一次订阅推送</el-button>
                                    </el-form-item>
                                </el-form>
                            </el-card>
                        </div>
                    </div>

                    <div v-if="activeMenu === 'settings_115'">
                        <h2>☁️ 115网盘登录</h2>
                        <div class="settings-wrapper">
                            <el-alert title="获取 115 Cookie 授权" type="info" description="通过官方扫码接口安全获取 Cookie，存入数据库供后台自动推送任务使用。" show-icon class="mb-20"></el-alert>
                            
                            <el-card shadow="never" class="mb-20">
                                <template #header>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>当前 Cookie 状态</span>
                                        <el-tag :type="config.cookie_115 ? 'success' : 'danger'">
                                            {{ config.cookie_115 ? '已配置有效 CK' : '未登录' }}
                                        </el-tag>
                                    </div>
                                </template>
                                <el-input v-model="config.cookie_115" type="textarea" :rows="4" placeholder="未提取到 Cookie，请通过下方生成二维码扫码获取..." disabled></el-input>
                            </el-card>

                            <div class="qr-container">
                                <el-button type="primary" size="large" @click="generate115QrCode" :loading="qrLoading" :disabled="pollTimer !== null">
                                    {{ pollTimer ? '正在等待扫码...' : '获取 115 登录二维码' }}
                                </el-button>
                                
                                <div v-if="qrCodeImgUrl" style="text-align: center; margin-top: 20px;">
                                    <h3>{{ qrStatusText }}</h3>
                                    <img :src="qrCodeImgUrl" class="qr-img" alt="115 登录二维码">
                                    <p style="color: #666; font-size: 14px;">请打开手机 115 客户端扫描上方二维码</p>
                                    <el-button type="danger" size="small" plain @click="stopQrPoll">取消扫码</el-button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="activeMenu === 'system_logs'">
                        <div class="top-bar">
                            <h2>📋 系统运行日志</h2>
                            <el-button type="primary" plain circle @click="loadLogs">↻</el-button>
                        </div>
                        <el-table :data="systemLogs" style="width: 100%" v-loading="loading" height="calc(100vh - 150px)">
                            <el-table-column prop="created_at" label="时间" width="180"></el-table-column>
                            <el-table-column prop="level" label="级别" width="100">
                                <template #default="scope">
                                    <el-tag :type="scope.row.level === 'ERROR' ? 'danger' : (scope.row.level === 'SUCCESS' ? 'success' : (scope.row.level === 'WARN' ? 'warning' : 'info'))">
                                        {{ scope.row.level }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="message" label="日志详情"></el-table-column>
                        </el-table>
                    </div>
                </el-main>
            </el-container>
        </el-container>

        <el-dialog v-model="pansouDialogVisible" :title="'🔍 网盘资源: ' + currentSearchKw" width="850px" destroy-on-close>
            <div v-loading="pansouLoading" style="min-height: 200px;">
                <el-tabs v-if="pansouResults && Object.keys(pansouResults).length > 0">
                    <el-tab-pane v-for="(links, type) in pansouResults" :key="type" :label="type.toUpperCase() + ' (' + links.length + ')'">
                        <el-table :data="links" stripe style="width: 100%" height="400">
                            <el-table-column prop="source" label="来源" width="100"><template #default="scope"><el-tag size="small" type="info">{{ scope.row.source || '未知' }}</el-tag></template></el-table-column>
                            <el-table-column prop="note" label="资源说明" width="220" show-overflow-tooltip></el-table-column>
                            <el-table-column label="网盘链接"><template #default="scope"><el-link type="primary" :href="scope.row.url" target="_blank">{{ scope.row.url }}</el-link></template></el-table-column>
                            <el-table-column prop="password" label="提取码" width="90"><template #default="scope"><el-tag type="danger" v-if="scope.row.password">{{ scope.row.password }}</el-tag><span v-else>-</span></template></el-table-column>
                        </el-table>
                    </el-tab-pane>
                </el-tabs>
                <el-empty v-else-if="!pansouLoading" description="未能搜索到相关网盘资源，请尝试更换关键词"></el-empty>
            </div>
        </el-dialog>
    </div>

    <script src="/static/app.js"></script>
</body>
</html>